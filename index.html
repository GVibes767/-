<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Подключение: Семья в действии</title>
    <!-- Библиотеки: React, Babel, Tailwind, Firebase -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, updateDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.FB = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, collection, doc, setDoc, onSnapshot, addDoc, updateDoc, serverTimestamp, query };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        .active-tab { color: #eab308 !important; }
        
        /* Анимации */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Кастомные стили для инпутов */
        input, textarea { outline: none !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Встроенные SVG иконки вместо Lucide (для стабильности)
        const Icon = ({ name, size = 20, className = "", fill = "none" }) => {
            const icons = {
                Users: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
                Heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>,
                Award: <><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></>,
                MessageSquare: <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>,
                User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
                Search: <><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>,
                CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></>,
                Flame: <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>,
                Briefcase: <><path d="M16 20V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/><rect width="20" height="14" x="2" y="6" rx="2"/></>,
                HelpCircle: <><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></>,
                Edit2: <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
            };
            return (
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width={size}
                    height={size}
                    viewBox="0 0 24 24"
                    fill={fill}
                    stroke="currentColor"
                    strokeWidth="2"
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    className={className}
                >
                    {icons[name]}
                </svg>
            );
        };

        const SPIRITUAL_GIFTS = [
            "Администрирование", "Распознавание духов", "Евангелизм", "Вера", 
            "Даяние", "Исцеление", "Помощь", "Гостеприимство", "Знание", 
            "Лидерство", "Милосердие", "Пророчество", "Служение", "Учительство", "Мудрость"
        ];

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'connection-community-v1';

        function App() {
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [activeTab, setActiveTab] = useState('profile');
            const [loading, setLoading] = useState(true);
            
            const [profiles, setProfiles] = useState([]);
            const [needs, setNeeds] = useState([]);
            const [achievements, setAchievements] = useState([]);
            const [myProfile, setMyProfile] = useState(null);

            // 1. Инициализация Firebase и Auth
            useEffect(() => {
                const config = JSON.parse(__firebase_config);
                const app = FB.initializeApp(config);
                const auth = FB.getAuth(app);
                const firestore = FB.getFirestore(app);
                setDb(firestore);

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await FB.signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await FB.signInAnonymously(auth);
                    }
                };
                
                initAuth().catch(console.error);

                const unsubscribe = FB.onAuthStateChanged(auth, (curr) => {
                    setUser(curr);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // 2. Слушатели Firestore
            useEffect(() => {
                if (!user || !db) return;

                const profilesRef = FB.collection(db, 'artifacts', appId, 'public', 'data', 'profiles');
                const unsubProfiles = FB.onSnapshot(profilesRef, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setProfiles(data);
                    const me = data.find(p => p.id === user.uid);
                    if (me) setMyProfile(me);
                }, (err) => console.error("Profiles error:", err));

                const needsRef = FB.collection(db, 'artifacts', appId, 'public', 'data', 'needs');
                const unsubNeeds = FB.onSnapshot(needsRef, (snap) => {
                    setNeeds(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                }, (err) => console.error("Needs error:", err));

                const achRef = FB.collection(db, 'artifacts', appId, 'public', 'data', 'achievements');
                const unsubAch = FB.onSnapshot(achRef, (snap) => {
                    setAchievements(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                }, (err) => console.error("Achievements error:", err));

                return () => { unsubProfiles(); unsubNeeds(); unsubAch(); };
            }, [user, db]);

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-950">
                    <div className="animate-spin rounded-full h-10 w-10 border-t-2 border-yellow-500"></div>
                </div>
            );

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24 border-x border-slate-900 bg-slate-950 flex flex-col shadow-2xl">
                    {/* Header */}
                    <header className="p-5 bg-slate-900/80 backdrop-blur sticky top-0 z-50 border-b border-slate-800 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <Icon name="Flame" className="text-yellow-500" size={24} fill="currentColor" />
                            <h1 className="font-black uppercase tracking-tighter text-xl italic">Подключение</h1>
                        </div>
                        <div className="text-[10px] bg-slate-800 px-2 py-1 rounded font-mono text-slate-400 border border-slate-700">
                            {user?.uid.substring(0, 6)}
                        </div>
                    </header>

                    {/* Main Scrollable Area */}
                    <main className="flex-1 p-4 overflow-y-auto custom-scroll">
                        <div className="fade-in">
                            {activeTab === 'profile' && <ProfileView user={user} db={db} myProfile={myProfile} />}
                            {activeTab === 'market' && <MarketView profiles={profiles} userId={user.uid} />}
                            {activeTab === 'needs' && <NeedsView needs={needs} user={user} db={db} userName={myProfile?.name} />}
                            {activeTab === 'achievements' && <AchievementsView achievements={achievements} user={user} db={db} userName={myProfile?.name} />}
                        </div>
                    </main>

                    {/* Navigation */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur border-t border-slate-800 p-3 flex justify-around items-center max-w-md mx-auto z-50">
                        <NavTab id="profile" icon="User" label="Я" active={activeTab} set={setActiveTab} />
                        <NavTab id="market" icon="Users" label="Биржа" active={activeTab} set={setActiveTab} />
                        <NavTab id="needs" icon="Heart" label="Молитва" active={activeTab} set={setActiveTab} />
                        <NavTab id="achievements" icon="Award" label="Успехи" active={activeTab} set={setActiveTab} />
                    </nav>
                </div>
            );
        }

        function NavTab({ id, icon, label, active, set }) {
            return (
                <button onClick={() => set(id)} className={`flex flex-col items-center gap-1 transition-all flex-1 ${active === id ? 'text-yellow-500' : 'text-slate-500'}`}>
                    <Icon name={icon} size={20} />
                    <span className="text-[10px] font-bold uppercase tracking-widest">{label}</span>
                </button>
            );
        }

        // --- Вкладка ПРОФИЛЬ ---
        function ProfileView({ user, db, myProfile }) {
            const [edit, setEdit] = useState(!myProfile);
            const [form, setForm] = useState({
                name: '', tg: '', gifts: [], customGift: '', sideA: '', sideB: ''
            });

            // Синхронизация формы при получении данных профиля
            useEffect(() => {
                if (myProfile) {
                    setForm({
                        name: myProfile.name || '',
                        tg: myProfile.tg || '',
                        gifts: myProfile.gifts || [],
                        customGift: myProfile.customGift || '',
                        sideA: myProfile.sideA || '',
                        sideB: myProfile.sideB || ''
                    });
                    setEdit(false);
                }
            }, [myProfile]);

            const save = async () => {
                if (!form.name.trim()) return alert("Введите имя");
                try {
                    const profileRef = FB.doc(db, 'artifacts', appId, 'public', 'data', 'profiles', user.uid);
                    await FB.setDoc(profileRef, {
                        ...form,
                        updatedAt: FB.serverTimestamp()
                    });
                    setEdit(false);
                } catch (e) {
                    console.error("Save error:", e);
                }
            };

            const toggleGift = (g) => {
                const newGifts = form.gifts.includes(g) 
                    ? form.gifts.filter(x => x !== g) 
                    : [...form.gifts, g];
                setForm({...form, gifts: newGifts});
            };

            if (edit) return (
                <div className="space-y-6">
                    <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800">
                        <h3 className="text-yellow-500 text-[10px] font-black uppercase mb-4 tracking-widest">Основная информация</h3>
                        <input className="w-full bg-slate-950 p-4 rounded-xl border border-slate-800 mb-3 outline-none focus:border-yellow-500 transition-all text-sm" 
                               placeholder="Ваше Имя и Фамилия" value={form.name} onChange={e => setForm({...form, name: e.target.value})} />
                        <input className="w-full bg-slate-950 p-4 rounded-xl border border-slate-800 outline-none focus:border-yellow-500 transition-all text-sm" 
                               placeholder="Telegram @username" value={form.tg} onChange={e => setForm({...form, tg: e.target.value})} />
                    </div>

                    <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800">
                        <h3 className="text-yellow-500 text-[10px] font-black uppercase mb-4 tracking-widest">Духовные дары</h3>
                        <div className="flex flex-wrap gap-2 mb-4">
                            {SPIRITUAL_GIFTS.map(g => (
                                <button key={g} onClick={() => toggleGift(g)} className={`px-3 py-2 rounded-lg text-[11px] font-bold transition-all ${form.gifts.includes(g) ? 'bg-yellow-500 text-slate-950' : 'bg-slate-800 text-slate-400 border border-slate-700'}`}>
                                    {g}
                                </button>
                            ))}
                        </div>
                        <input className="w-full bg-slate-950 p-3 rounded-xl border border-slate-800 text-sm italic" 
                               placeholder="Свой вариант дара..." value={form.customGift} onChange={e => setForm({...form, customGift: e.target.value})} />
                    </div>

                    <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800">
                        <h3 className="text-blue-400 text-[10px] font-black uppercase mb-2 tracking-widest italic">Сторона А: Я умею / Ресурс</h3>
                        <textarea className="w-full bg-slate-950 p-4 rounded-xl border border-slate-800 text-sm min-h-[100px] outline-none" 
                                  placeholder="В чем вы мастер? Чем можете послужить семье?" 
                                  value={form.sideA} onChange={e => setForm({...form, sideA: e.target.value})} />
                    </div>

                    <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800">
                        <h3 className="text-red-400 text-[10px] font-black uppercase mb-2 tracking-widest italic">Сторона Б: Мне нужно / Нужда</h3>
                        <textarea className="w-full bg-slate-950 p-4 rounded-xl border border-slate-800 text-sm min-h-[100px] outline-none" 
                                  placeholder="В какой помощи вы нуждаетесь сегодня? (совет, молитва, дело)" 
                                  value={form.sideB} onChange={e => setForm({...form, sideB: e.target.value})} />
                    </div>

                    <button onClick={save} className="w-full bg-yellow-500 text-slate-950 p-5 rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-all">
                        Сохранить Профиль
                    </button>
                </div>
            );

            if (!myProfile) return null;

            return (
                <div className="space-y-4">
                    <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 relative overflow-hidden">
                        <button onClick={() => setEdit(true)} className="absolute top-4 right-4 text-slate-500 hover:text-yellow-500 transition-colors">
                            <Icon name="Edit2" size={18} />
                        </button>
                        <div className="flex items-center gap-4 mb-6">
                            <div className="w-16 h-16 bg-yellow-500/10 rounded-2xl flex items-center justify-center text-yellow-500 border border-yellow-500/20">
                                <Icon name="User" size={32}/>
                            </div>
                            <div>
                                <h2 className="text-xl font-black uppercase italic leading-none">{myProfile.name}</h2>
                                <p className="text-slate-500 text-sm font-bold mt-2">{myProfile.tg || '@no_username'}</p>
                            </div>
                        </div>
                        <div className="flex flex-wrap gap-1.5">
                            {(myProfile.gifts || []).map(g => (
                                <span key={g} className="bg-slate-800 text-slate-300 text-[9px] px-2 py-1 rounded font-bold uppercase tracking-wider border border-slate-700">{g}</span>
                            ))}
                            {myProfile.customGift && (
                                <span className="bg-yellow-500/10 text-yellow-500 text-[9px] px-2 py-1 rounded font-bold italic border border-yellow-500/20">{myProfile.customGift}</span>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-3">
                        <div className="bg-slate-900 p-5 rounded-3xl border border-blue-500/20">
                            <div className="flex items-center gap-2 text-blue-400 mb-3">
                                <Icon name="Briefcase" size={14}/>
                                <span className="text-[9px] font-black uppercase tracking-widest">Могу</span>
                            </div>
                            <p className="text-xs text-slate-300 leading-relaxed italic">«{myProfile.sideA || "Не заполнено"}»</p>
                        </div>
                        <div className="bg-slate-900 p-5 rounded-3xl border border-red-500/20">
                            <div className="flex items-center gap-2 text-red-400 mb-3">
                                <Icon name="HelpCircle" size={14}/>
                                <span className="text-[9px] font-black uppercase tracking-widest">Ищу</span>
                            </div>
                            <p className="text-xs text-slate-300 leading-relaxed">«{myProfile.sideB || "Не заполнено"}»</p>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Вкладка БИРЖА ---
        function MarketView({ profiles, userId }) {
            const [search, setSearch] = useState('');
            const filtered = useMemo(() => {
                return profiles.filter(p => 
                    p.id !== userId && 
                    (p.name.toLowerCase().includes(search.toLowerCase()) || 
                     (p.sideA && p.sideA.toLowerCase().includes(search.toLowerCase())))
                );
            }, [profiles, search, userId]);

            return (
                <div className="space-y-4">
                    <div className="relative">
                        <Icon name="Search" className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500" size={18}/>
                        <input className="w-full bg-slate-900 p-4 pl-12 rounded-2xl border border-slate-800 text-sm outline-none focus:border-yellow-500/50" 
                               placeholder="Найти талант или нужду..." value={search} onChange={e => setSearch(e.target.value)} />
                    </div>
                    
                    <div className="space-y-3">
                        {filtered.length > 0 ? filtered.map(p => (
                            <div key={p.id} className="bg-slate-900/50 p-5 rounded-3xl border border-slate-800 transition-all hover:bg-slate-900">
                                <div className="flex justify-between items-start mb-4">
                                    <h4 className="font-black text-sm uppercase tracking-tight text-yellow-500 italic">{p.name}</h4>
                                    <span className="text-[10px] bg-slate-800 px-2 py-1 rounded text-slate-500 font-bold">{p.tg || '@...'}</span>
                                </div>
                                <div className="space-y-3">
                                    <div className="bg-slate-950/50 p-3 rounded-xl border border-blue-500/10">
                                        <span className="text-[8px] font-black uppercase text-blue-500 block mb-1 tracking-widest">Ресурс:</span>
                                        <p className="text-xs text-slate-300 italic">«{p.sideA || "..."}»</p>
                                    </div>
                                    <div className="bg-slate-950/50 p-3 rounded-xl border border-red-500/10">
                                        <span className="text-[8px] font-black uppercase text-red-500 block mb-1 tracking-widest">Нужда:</span>
                                        <p className="text-xs text-slate-400">«{p.sideB || "..."}»</p>
                                    </div>
                                </div>
                            </div>
                        )) : (
                            <div className="text-center py-10 text-slate-600 text-sm uppercase font-black tracking-widest">Никто не найден</div>
                        )}
                    </div>
                </div>
            );
        }

        // --- Вкладка МОЛИТВА ---
        function NeedsView({ needs, user, db, userName }) {
            const [txt, setTxt] = useState('');
            
            const add = async () => {
                if(!txt.trim()) return;
                try {
                    await FB.addDoc(FB.collection(db, 'artifacts', appId, 'public', 'data', 'needs'), {
                        userId: user.uid, 
                        userName: userName || "Аноним", 
                        text: txt, 
                        status: 'open', 
                        createdAt: FB.serverTimestamp()
                    });
                    setTxt('');
                } catch (e) { console.error(e); }
            };

            const markAsAnswered = async (id) => {
                const docRef = FB.doc(db, 'artifacts', appId, 'public', 'data', 'needs', id);
                await FB.updateDoc(docRef, { status: 'answered' });
            };

            return (
                <div className="space-y-6">
                    <div className="bg-slate-900 p-5 rounded-3xl border border-slate-800">
                        <h3 className="text-yellow-500 text-[10px] font-black uppercase mb-3 tracking-widest">Стена молитвы</h3>
                        <textarea className="w-full bg-slate-950 p-4 rounded-xl border border-slate-800 text-sm mb-3 h-20 outline-none focus:border-yellow-500/30" 
                                  placeholder="Напишите вашу нужду..." value={txt} onChange={e => setTxt(e.target.value)} />
                        <button onClick={add} className="w-full bg-slate-100 text-slate-950 p-3 rounded-xl font-black uppercase text-xs tracking-widest">Опубликовать</button>
                    </div>

                    <div className="space-y-3">
                        {needs.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).map(n => (
                            <div key={n.id} className={`p-5 rounded-3xl border transition-all ${n.status === 'answered' ? 'bg-green-500/5 border-green-500/20 opacity-60' : 'bg-slate-900 border-slate-800'}`}>
                                <div className="flex justify-between items-start mb-2">
                                    <span className="text-[10px] font-black uppercase text-slate-500 italic tracking-wider">{n.userName}</span>
                                    {n.status === 'answered' && <Icon name="CheckCircle" className="text-green-500" size={16}/>}
                                </div>
                                <p className={`text-sm ${n.status === 'answered' ? 'text-green-200 line-through' : 'text-slate-300'}`}>{n.text}</p>
                                {n.userId === user.uid && n.status !== 'answered' && (
                                    <button onClick={() => markAsAnswered(n.id)} 
                                            className="mt-3 text-[10px] font-black uppercase text-yellow-500 underline underline-offset-4">Есть ответ!</button>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // --- Вкладка УСПЕХИ ---
        function AchievementsView({ achievements, user, db, userName }) {
            const [txt, setTxt] = useState('');
            
            const add = async () => {
                if(!txt.trim()) return;
                try {
                    await FB.addDoc(FB.collection(db, 'artifacts', appId, 'public', 'data', 'achievements'), {
                        userId: user.uid, 
                        userName: userName || "Студент", 
                        msg: txt, 
                        createdAt: FB.serverTimestamp()
                    });
                    setTxt('');
                } catch (e) { console.error(e); }
            };

            return (
                <div className="space-y-6">
                    <div className="bg-yellow-500 p-6 rounded-[2rem] text-slate-950 shadow-xl shadow-yellow-900/20">
                        <h3 className="font-black uppercase text-[10px] mb-3 tracking-widest">Твоя победа</h3>
                        <input className="w-full bg-white/20 border border-black/10 p-4 rounded-xl placeholder:text-slate-700 font-bold outline-none" 
                               placeholder="Я прошел тест 5 урока! / Нашел призвание!" value={txt} onChange={e => setTxt(e.target.value)} />
                        <button onClick={add} className="w-full bg-slate-950 text-white mt-4 p-4 rounded-xl font-black uppercase text-xs tracking-widest">Сбросить в ленту</button>
                    </div>

                    <div className="space-y-3">
                        {achievements.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).map(a => (
                            <div key={a.id} className="bg-slate-900/40 p-5 rounded-3xl border border-slate-800 flex items-center gap-4 transition-all hover:border-yellow-500/30">
                                <div className="w-12 h-12 bg-yellow-500/10 rounded-xl flex items-center justify-center text-yellow-500 flex-shrink-0 border border-yellow-500/10">
                                    <Icon name="Award" size={24}/>
                                </div>
                                <div className="flex-1">
                                    <p className="text-xs font-bold leading-tight"><span className="text-yellow-500 uppercase italic mr-1">{a.userName}:</span> {a.msg}</p>
                                    <span className="text-[8px] text-slate-600 font-black uppercase mt-2 block tracking-widest">Достижение получено</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>